name: Test API

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test API
      run: |
        python -c "
        import requests
        import time
        import subprocess
        import sys
        
        # Start the API
        process = subprocess.Popen([sys.executable, '-m', 'uvicorn', 'main:app', '--host', '127.0.0.1', '--port', '8000'])
        
        # Wait for API to start
        time.sleep(5)
        
        try:
            # Test health endpoint
            response = requests.get('http://127.0.0.1:8000/health')
            assert response.status_code == 200
            print('Health check passed')
            
            # Test prediction endpoint
            test_data = {
                'failures': 0, 'higher': 1, 'absences': 3,
                'freetime': 2, 'goout': 3, 'famrel': 4,
                'famsup': 1, 'schoolsup': 0, 'paid': 1,
                'traveltime': 2, 'health': 5, 'internet': 1, 'age': 17
            }
            
            response = requests.post('http://127.0.0.1:8000/predict', json=test_data)
            assert response.status_code == 200
            print('Prediction endpoint working')
            
        finally:
            process.terminate()
        "
